<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="Webmaster" />
    <meta name="robots" content="index, follow"/>

    <meta property="og:title" content="How to Use Cloud-init to Customize New OpenStack VMs"/>
    <meta property="og:url" content="../../../posts/2015/02/use-cloud-init-to-customize-new-openstack-vms.html"/>
    <meta property="og:site_name" content="IT.met.no"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="../../../posts/2015/02/use-cloud-init-to-customize-new-openstack-vms.html" />

    <title>How to Use Cloud-init to Customize New OpenStack VMs | IT.met.no</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />

    <link rel="stylesheet" type="text/css" href="../../../theme/css/main.css" />
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="IT.met.no Atom Feed" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="../../../">IT.met.no </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li ><a href="/index.html">home</a></li>
                            <li ><a href="/pages/about.html">about</a></li>
                            <li ><a href="/pages/howto.html">howto</a></li>
                            <li ><a href="#">|</a></li>
                            <li class="active"><a href="../../../category/blog.html">blog</a></li>
                        </ul>

                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="../../../posts/2015/02/use-cloud-init-to-customize-new-openstack-vms.html" rel="bookmark"
             title="Permalink to How to Use Cloud-init to Customize New OpenStack VMs">How to Use Cloud-init to Customize New OpenStack VMs</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="../../../author/arnesundmetno.html">arne.sund@met.no</a>
    </address>

    in <a href="../../../category/blog.html">blog</a>

    on 2015-02-05

        |
        tags:         <a href="../../../tag/openstack.html">openstack</a>
        <a href="../../../tag/cloud-init.html">cloud-init</a>
        <a href="../../../tag/bootstrap.html">bootstrap</a>
        <a href="../../../tag/nova-boot.html">nova boot</a>
        <a href="../../../tag/ubuntu.html">ubuntu</a>
        <a href="../../../tag/cloud-config.html">cloud-config</a>
        <a href="../../../tag/howto.html">howto</a>



    
</footer><!-- /.post-info -->

        <p><em>Originally published on <a href="http://arnesund.com/2015/02/05/how-to-use-cloud-init-to-customize-new-openstack-vms/">arnesund.com</a></em></p>
<p>When creating a new instance (VM) on OpenStack with one of the standard <a href="http://cloud-images.ubuntu.com/releases/">Ubuntu Cloud images</a>, the next step is typically to install packages and configure applications. Instead of doing that manually every time, OpenStack enables automatic setup of new instances using <a href="http://cloudinit.readthedocs.org/en/latest/">Cloud-init</a>. Cloud-init runs on first boot of every new instance and initializes it according to a provided script or config file. The functionality is part of the Ubuntu image and works the same way regardless of the cloud provider used (Amazon, RackSpace, private OpenStack cloud). Cloud-init is also available for <a href="http://cloudinit.readthedocs.org/en/latest/topics/availability.html">other distributions</a> as well.</p>
<h2>Creating a customization script</h2>
<h3>Standard Bash script</h3>
<p>Perhaps the easiest way to get started is to create a standard Bash script that Cloud-init runs on first boot. Here is a simple example to get Apache2 up and running:</p>
<div class="highlight"><pre>cat &gt; cloudinit.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">&gt; #!/bin/bash</span>
<span class="s">&gt; apt-get update</span>
<span class="s">&gt; apt-get -y install apache2</span>
<span class="s">&gt; a2ensite 000-default</span>
<span class="s">&gt; EOF</span>
</pre></div>


<p>This small script installs the Apache2 package and enables the default site. Of course, you’d likely need to do more configuration here before enabling the site, like an rsync of web content to document root and enabling TLS.</p>
<h2>Launch a new web instance</h2>
<p>Use the nova CLI command to launch an instance named <code>web1</code> and supply the filename of the customization script with the <code>-–user-data</code> argument:</p>
<div class="highlight"><pre>nova boot --flavor m1.medium --image <span class="s2">&quot;Ubuntu CI trusty 2014-09-22&quot;</span> --key-name arnes --user-data<span class="o">=</span>cloudinit.sh web1
+-----------+---------------------+
<span class="p">|</span> Property  <span class="p">|</span> Value               <span class="p">|</span>
+-----------+---------------------+
<span class="p">|</span> name      <span class="p">|</span> web1                <span class="p">|</span>
<span class="p">|</span> flavor    <span class="p">|</span> m1.medium <span class="o">(</span>3<span class="o">)</span>       <span class="p">|</span>
...
</pre></div>


<p>To access the instance from outside the cloud, allocate a new floating IP and associate it with the new instance:</p>
<div class="highlight"><pre>nova floating-ip-create public
+------------+-----------+----------+--------+
<span class="p">|</span> Ip         <span class="p">|</span> Server Id <span class="p">|</span> Fixed Ip <span class="p">|</span> Pool   <span class="p">|</span>
+------------+-----------+----------+--------+
<span class="p">|</span> 10.99.1.71 <span class="p">|</span>           <span class="p">|</span> -        <span class="p">|</span> public <span class="p">|</span>
+------------+-----------+----------+--------+

nova floating-ip-associate web1 10.99.1.71
</pre></div>


<h2>Results</h2>
<p>The new web instance has Apache running right from the start, no manual steps needed:</p>
<p><img alt="Apache2 default page" src="../../../images/apache2-set-up-using-cloudinit.png" /></p>
<h3>More Cloud-init options: Cloud-Config syntax</h3>
<p>Cloud-init can do more than just run bash scripts. Using cloud-config syntax many different actions are possible. The documentation has <a href="http://cloudinit.readthedocs.org/en/latest/topics/examples.html">many useful examples</a> of cloud-config syntax to add user accounts, configure mount points, initialize the instance as a Chef/Puppet client and much more.</p>
<p>For example, the same Apache2 initialization as above can be done with the following cloud-config statements:</p>
<div class="highlight"><pre>#cloud-config
packages:
 - apache2
runcmd:
 - [ a2ensite, &quot;000-default&quot; ]
</pre></div>


<h2>Including scripts or config files</h2>
<p>Including a script or config file from an external source is also possible. This can be useful if the config file is under revision control in Git. Including files is easy, just replace the script contents with an include statement and the URL:</p>
<div class="highlight"><pre>#include
https://gist.githubusercontent.com/arnesund/7332e15c5eb9df8c55aa/raw/0bd63296980bb4d8bf33387cfdb2eb60b964490d/cloudinit.conf
</pre></div>


<p>The <a href="Simple cloud-config example">gist</a> contains the same cloud-config statements as above, so the end result it the same.</p>
<h2>Troubleshooting</h2>
<p>Cloud-init logs messages to <code>/var/log/cloud-init.log</code> and in my tests even debug level messages were logged. In addition, Cloud-init records all console output from changes it performs to <code>/var/log/cloud-init-output.log</code>. That makes it easy to catch errors in the initialization scripts, like for instance when I omitted ‘-y’ to apt-get install and package installation failed:</p>
<div class="highlight"><pre>The following NEW packages will be installed:
 apache2 apache2-bin apache2-data libapr1 libaprutil1 libaprutil1-dbd-sqlite3
 libaprutil1-ldap ssl-cert
0 upgraded, 8 newly installed, 0 to remove and 88 not upgraded.
Need to get 1284 kB of archives.
After this operation, 5342 kB of additional disk space will be used.
Do you want to continue? [Y/n] Abort.
/var/lib/cloud/instance/scripts/part-001: line 4: a2ensite: command not found
2015-02-05 09:59:56,943 - util.py[WARNING]: Failed running /var/lib/cloud/instance/scripts/part-001 [127]
2015-02-05 09:59:56,944 - cc_scripts_user.py[WARNING]: Failed to run module scripts-user (scripts in /var/lib/cloud/instance/scripts)
2015-02-05 09:59:56,945 - util.py[WARNING]: Running scripts-user (&lt;module &#39;cloudinit.config.cc_scripts_user&#39; from &#39;/usr/lib/python2.7/dist-packages/cloudinit/config/cc_scripts_user.pyc&#39;&gt;) failed
Cloud-init v. 0.7.5 finished at Thu, 05 Feb 2015 09:59:56 +0000. Datasource DataSourceOpenStack [net,ver=2]. Up 22.14 seconds
</pre></div>


<p>The line "Do you want to continue? [Y/n] Abort." is a clear indicator that apt-get install failed since it expected user input. Most CLI tools can be run without user input by just passing the correct options, like '-y' to apt-get. After correcting that error, the output is as expected:</p>
<div class="highlight"><pre>The following NEW packages will be installed:
 apache2 apache2-bin apache2-data libapr1 libaprutil1 libaprutil1-dbd-sqlite3
 libaprutil1-ldap ssl-cert
0 upgraded, 8 newly installed, 0 to remove and 88 not upgraded.
Need to get 1284 kB of archives.
After this operation, 5342 kB of additional disk space will be used.
Get:1 http://nova.clouds.archive.ubuntu.com/ubuntu/ trusty/main libapr1 amd64 1.5.0-1 [85.1 kB]
Get:2 http://nova.clouds.archive.ubuntu.com/ubuntu/ trusty/main libaprutil1 amd64 1.5.3-1 [76.4 kB]
...
Cloud-init v. 0.7.5 running &#39;modules:final&#39; at Thu, 05 Feb 2015 12:35:49 +0000. Up 38.42 seconds.
Site 000-default already enabled
Cloud-init v. 0.7.5 finished at Thu, 05 Feb 2015 12:35:49 +0000. Datasource DataSourceOpenStack [net,ver=2]. Up 38.56 seconds
</pre></div>


<p>This also reveals that the command "a2ensite 000-default" is not needed since the default site is enabled already. However, it’s included here as an example of how to run shell commands using cloud-config statements.</p>
<h2>Testing vs Production</h2>
<p>Using Cloud-init to get new instances to the desired state is nice when testing and a necessary step when deploying production instances. In a production context, one would probably use Cloud-init to initialize the instance as a Chef or Puppet client. From there, Chef/Puppet takes over the configuration task and will make sure the instance is set up according to the desired role it should fill. Cloud-init makes the initial bootstrapping of the instance easy.</p>

      </div><!-- /.entry-content -->

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>