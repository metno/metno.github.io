<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="Webmaster" />
    <meta name="robots" content="index, follow"/>

    <meta property="og:title" content="Production OpenStack"/>
    <meta property="og:url" content="../../../posts/2015/12/OpenStack.html"/>
    <meta property="og:site_name" content="IT.met.no"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="../../../posts/2015/12/OpenStack.html" />

    <title>Production OpenStack | IT.met.no</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />

    <link rel="stylesheet" type="text/css" href="../../../theme/css/main.css" />
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="IT.met.no Atom Feed" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="../../../">IT.met.no </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li ><a href="/index.html">home</a></li>
                            <li ><a href="/pages/about.html">about</a></li>
                            <li ><a href="/pages/howto.html">howto</a></li>
                            <li ><a href="#">|</a></li>
                            <li class="active"><a href="../../../category/blog.html">blog</a></li>
                        </ul>

                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="../../../posts/2015/12/OpenStack.html" rel="bookmark"
             title="Permalink to Production OpenStack">Production OpenStack</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="../../../author/sverrestoltenbergmetno.html">sverre.stoltenberg@met.no</a>
    </address>

    in <a href="../../../category/blog.html">blog</a>

    on 2015-12-15

        |
        tags:         <a href="../../../tag/private-cloud.html">private cloud</a>
        <a href="../../../tag/openstack.html">OpenStack</a>



    
</footer><!-- /.post-info -->

        <h2>Requirements</h2>
<p>The requirement of this OpenStack setup is to have a highly available
cloud spread over two or more data centers. It will replace the current
solution where a user is requesting a VM from the infrastructure
group, which is ineffective and time consuming.</p>
<p>The aim of the setup is to be able to lose one data center, without
affecting production. The use of containers makes it easier to scale
the services by adding more servers, and to set up an identical
staging environment to test upgrades or develop new services. </p>
<p>It was also a good opportunity to introduce new technology and when
you setup an OpenStack service as a container from scratch, you get
pretty familiar with the service.</p>
<p>We are not using <a href="https://docs.docker.com/engine/userguide/networking/get-started-overlay/">docker overlay network</a> at the moment, but it would
be nice to have it in the future, so we don't have to expose too many
internal services.</p>
<h3>Basic building blocks</h3>
<ul>
<li><a href="http://www.centos.org/">centos</a> The OS used of most containers and on the physical hosts</li>
<li><a href="https://consul.io/">consul</a> Service discovery</li>
<li><a href="https://github.com/gliderlabs/registrator">registrator</a> Feeds consul with info about containers</li>
<li><a href="https://docs.docker.com/machine/">docker-machine</a> Install <a href="https://docker.io/">docker</a> and <a href="https://github.com/docker/swarm">swarm</a></li>
<li><a href="https://docker.io/">docker</a> The container manager </li>
<li><a href="https://github.com/docker/swarm">swarm</a> Manage containers on many hosts</li>
<li><a href="https://docs.docker.com/compose/">docker-compose</a> Start and stop containers</li>
<li><a href="http://www.ansible.com/">ansible</a> Configuration management</li>
</ul>
<h3>Cluster services</h3>
<ul>
<li><a href="https://consul.io/">consul</a> Service discovery</li>
<li><a href="https://github.com/docker/swarm">swarm</a> Unifying docker on different physical hosts</li>
<li><a href="https://www.percona.com/software/mysql-database/percona-xtradb-cluster">percona-XtraDB</a> Clustered mysql database</li>
<li><a href="https://www.rabbitmq.com/">rabbitmq</a> Messagequeue</li>
<li><a href="http://www.haproxy.org/">haproxy</a> Loadbalancing api between datacenters, and terminate SSL</li>
<li><a href="https://code.google.com/p/moxi/">moxi</a> Clustered <a href="http://memcached.org/">memcached</a></li>
<li><a href="http://www.keepalived.org/">keepalived</a> Handeling shared ip address between datacenters.</li>
</ul>
<h3>Other services used</h3>
<ul>
<li><a href="http://ceph.com/">ceph</a> Block storage</li>
<li><a href="https://sensuapp.org/">sensu</a> Service monitoring</li>
<li><a href="https://influxdata.com/">influxdb</a> time series database</li>
<li><a href="http://grafana.org/">grafana</a> Graphing from <a href="https://influxdata.com/">influxdb</a></li>
<li><a href="https://github.com/influxdb/telegraf">telegraf</a> Feeding <a href="https://influxdata.com/">influxdb</a></li>
<li><a href="https://github.com/pklaus/docker-deployments/tree/master/whatsmyip">whatsmyip</a> Used by containers to discover what ip address the host they run on has.</li>
</ul>
<h2>Example: nova container</h2>
<h3>Docker file</h3>
<p>Here we make a container image, that can run all openstack nova
services, depending on how it is started. It get password and special
configuration from an environment file.</p>
<div class="highlight"><pre><span class="k">FROM</span><span class="s"> centos</span>

<span class="k">RUN</span> yum install -y http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm <span class="se">\</span>
    yum install -y epel-release <span class="se">\</span>
    yum install -y http://buildlogs.centos.org/centos/7/cloud/openstack-liberty/centos-release-openstack-liberty-1-3.el7.noarch.rpm

<span class="k">RUN</span> yum install -y <span class="se">\</span>
    <span class="nb">bind</span>-utils <span class="se">\</span>
    crudini <span class="se">\</span>
    mysql-client <span class="se">\</span>
    openstack-nova-api <span class="se">\</span>
    openstack-nova-api <span class="se">\</span>
    openstack-nova-cert <span class="se">\</span>
    openstack-nova-common <span class="se">\</span>
    openstack-nova-conductor <span class="se">\</span>
    openstack-nova-console <span class="se">\</span>
    openstack-nova-novncproxy <span class="se">\</span>
    openstack-nova-scheduler <span class="se">\</span>
    python-openstackclient <span class="se">\</span>
    python-pip

<span class="k">ADD</span><span class="s"> entrypoint.sh /entrypoint.sh</span>

<span class="k">ENTRYPOINT</span><span class="s"> [&quot;/entrypoint.sh&quot;]</span>

<span class="k">CMD</span><span class="s"> [&quot;/bin/bash&quot;]</span>
</pre></div>


<h3>entrypoint.sh</h3>
<div class="highlight"><pre><span class="c">#!/bin/bash </span>

<span class="c"># need to disable iptables-save and restore, at least for nova-api</span>
rm -f /usr/sbin/iptables-save
ln -s /bin/true /usr/sbin/iptables-save
rm -f /usr/sbin/iptables-restore
ln -s /bin/true /usr/sbin/iptables-restore

<span class="c"># Set verbose and job control</span>
<span class="nb">set</span> -v -m 

rm /etc/nova/nova.conf
touch /etc/nova/nova.conf
chown root.nova /etc/nova/nova.conf
chown <span class="m">640</span> /etc/nova/nova.conf

<span class="nv">CONF</span><span class="o">=</span><span class="s2">&quot;crudini --set /etc/nova/nova.conf&quot;</span>

<span class="nv">$CONF</span> database connection mysql://<span class="nv">$NOVA_DBUSER</span>:<span class="nv">$NOVA_DBPASS</span>@<span class="nv">$MYSQL_HOST</span>/nova?charset<span class="o">=</span>utf8

<span class="nv">$CONF</span> DEFAULT verbose <span class="nb">true</span>
<span class="nv">$CONF</span> DEFAULT debug <span class="nb">true</span>
<span class="nv">$CONF</span> DEFAULT logfile <span class="s2">&quot;&quot;</span>
<span class="nv">$CONF</span> DEFAULT auth_strategy keystone

<span class="c">#availability zones</span>
<span class="nv">$CONF</span> DEFAULT default_availability_zone <span class="nv">$DATACENTER</span>
<span class="nv">$CONF</span> DEFAULT default_schedule_zone <span class="nv">$DATACENTER</span>
<span class="nv">$CONF</span> DEFAULT cross_az_attach False

<span class="c"># rabbit</span>
<span class="nv">$CONF</span> DEFAULT rpc_backend rabbit
<span class="nv">$CONF</span> DEFAULT rabbit_host <span class="nv">$RABBIT_HOST</span>
<span class="nv">$CONF</span> DEFAULT rabbit_userid <span class="nv">$RABBIT_USER</span>
<span class="nv">$CONF</span> DEFAULT rabbit_password <span class="nv">$RABBIT_PASS</span>

<span class="c"># Legacy networking http://docs.openstack.org/icehouse/install-guide/install/yum/content/section_nova-networking.html</span>
<span class="nv">$CONF</span> DEFAULT network_api_class nova.network.api.API
<span class="nv">$CONF</span> DEFAULT security_group_api nova

<span class="nv">$CONF</span> DEFAULT network_manager nova.network.manager.VlanManager
<span class="nv">$CONF</span> DEFAULT vlan_start 400
<span class="nv">$CONF</span> DEFAULT vlan_interface br0

<span class="nv">$CONF</span> glance host <span class="nv">$ENDPOINT_IP</span>
<span class="nv">$CONF</span> oslo_concurrency lock_path /var/lib/nova/tmp

<span class="c"># Check if the keystone database exist, if not create</span>
<span class="k">if</span> ! mysql -h<span class="nv">$MYSQL_HOST</span> -u<span class="nv">$MYSQL_DBUSER</span> -p<span class="nv">$MYSQL_DBPASS</span> nova -e <span class="s1">&#39;QUIT&#39;</span> <span class="p">;</span> <span class="k">then</span>
    mysql -h<span class="nv">$MYSQL_HOST</span> -u<span class="nv">$MYSQL_DBUSER</span> -p<span class="nv">$MYSQL_DBPASS</span> mysql -e <span class="s2">&quot;CREATE DATABASE nova;&quot;</span>
    mysql -h<span class="nv">$MYSQL_HOST</span> -u<span class="nv">$MYSQL_DBUSER</span> -p<span class="nv">$MYSQL_DBPASS</span> mysql -e <span class="s2">&quot;GRANT ALL ON nova.* TO &#39;</span><span class="nv">$NOVA_DBUSER</span><span class="s2">&#39;@&#39;%&#39; IDENTIFIED BY &#39;</span><span class="nv">$NOVA_DBPASS</span><span class="s2">&#39;;&quot;</span>
<span class="k">fi</span>

nova-manage db sync

<span class="nv">OS</span><span class="o">=</span><span class="s2">&quot;openstack --os-token=</span><span class="nv">$ADMIN_TOKEN</span><span class="s2"> --os-url=</span><span class="nv">$KEYSTONE_ADMIN_ENDPOINT</span><span class="s2">/</span><span class="nv">$KEYSTONE_ENDPOINT_VERSION</span><span class="s2">&quot;</span>

<span class="c"># Create a nova service</span>
<span class="k">if</span> ! <span class="nv">$OS</span> service show nova <span class="p">;</span> <span class="k">then</span>
    <span class="nv">$OS</span> service create --name nova --description <span class="s2">&quot;OpenStack Compute&quot;</span> compute
<span class="k">fi</span>

<span class="c"># Create nova endpoints</span>
<span class="k">if</span> ! <span class="nv">$OS</span> endpoint show compute <span class="p">;</span> <span class="k">then</span>
    <span class="nv">$OS</span> endpoint create --region <span class="nv">$ENDPOINT_REGION</span> --publicurl <span class="nv">$NOVA_ENDPOINT</span> --internalurl <span class="nv">$NOVA_ENDPOINT</span> --adminurl <span class="nv">$NOVA_ENDPOINT</span> compute
<span class="k">fi</span>

<span class="c"># Create service project</span>
<span class="k">if</span> ! <span class="nv">$OS</span> project show service <span class="p">;</span> <span class="k">then</span>
    <span class="nv">$OS</span> project create --description <span class="s2">&quot;Service Project&quot;</span> service
<span class="k">fi</span>

<span class="c"># Create service role</span>
<span class="k">if</span> ! <span class="nv">$OS</span> role show service <span class="p">;</span> <span class="k">then</span>
    <span class="nv">$OS</span> role create service
<span class="k">fi</span>

<span class="c"># give nova admin role in service project</span>
<span class="k">if</span> ! <span class="nv">$OS</span> user role list <span class="p">|</span> grep <span class="s2">&quot;service.*nova&quot;</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c"># Add the admin role to the admin project and user</span>
    <span class="nv">$OS</span> role add --project service --user nova admin
<span class="k">fi</span>

<span class="nb">exec</span> <span class="nv">$@</span>
</pre></div>


<h3>docker-compose.yml</h3>
<div class="highlight"><pre><span class="l-Scalar-Plain">nova-api</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">157.249.186.12:50000/nova</span>
  <span class="l-Scalar-Plain">hostname</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nova-api</span>
  <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
  <span class="l-Scalar-Plain">env_file</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openstack.env</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openstack-endpoints.env</span>
  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;58773:8773&quot;</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;58774:8774&quot;</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;58775:8775&quot;</span>
  <span class="l-Scalar-Plain">expose</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;8773&quot;</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;8774&quot;</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;8775&quot;</span>
  <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span> 
    <span class="p-Indicator">-</span> <span class="s">&quot;constraint:node==/ares-[ab][0-9]/&quot;</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">SERVICE_NAME=nova-api</span>
  <span class="l-Scalar-Plain">dns</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;172.17.0.1&quot;</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;157.249.16.22&quot;</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;157.249.16.20&quot;</span>
  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">su -s /bin/bash -c /usr/bin/nova-api nova</span>
</pre></div>

      </div><!-- /.entry-content -->

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>